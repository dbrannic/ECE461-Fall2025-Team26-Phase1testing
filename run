#!/bin/bash

install_dependencies() {
    PYTHON_CMD="python3"
    command -v python3 &>/dev/null || PYTHON_CMD="python"
    $PYTHON_CMD -m pip install -r requirements.txt --user &>/dev/null
    exit $?
}

run_tests() {
    PYTHON_CMD="python3"
    command -v python3 &>/dev/null || PYTHON_CMD="python"
    
    output=$($PYTHON_CMD -m pytest backend/src/Testing/ --cov=backend/src --cov-report=term -v 2>&1)
    exit_code=$?
    echo "$output" >&2
    
    passed=$(echo "$output" | grep -oE "[0-9]+ passed" | head -1 | grep -oE "[0-9]+")
    failed=$(echo "$output" | grep -oE "[0-9]+ failed" | head -1 | grep -oE "[0-9]+")
    total=$((${passed:-0} + ${failed:-0}))
    
    [ $total -eq 0 ] && {
        passed=$(echo "$output" | grep -c " PASSED")
        failed=$(echo "$output" | grep -c " FAILED")
        total=$((passed + failed))
    }
    
    coverage=$(echo "$output" | grep "^TOTAL" | tail -1 | grep -oE "[0-9]+%" | tail -1 | tr -d '%')
    
    echo "${passed:-0}/${total:-0} test cases passed. ${coverage:-0}% line coverage achieved."
    exit $exit_code
}

run_evaluation() {
    PYTHON_CMD="python3"
    command -v python3 &>/dev/null || PYTHON_CMD="python"
    cd backend && $PYTHON_CMD src/main.py "$1"
    exit $?
}

case "$1" in
    install) install_dependencies ;;
    test) run_tests ;;
    *) run_evaluation "$1" ;;
esac