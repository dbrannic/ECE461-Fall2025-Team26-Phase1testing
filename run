#!/bin/bash

# ML Model Evaluation System - Run Script
# Usage: ./run [install|test|URL_FILE]

set -e  # Exit on any error

# Function to install dependencies
install_dependencies() {
    echo "Installing ML Model Evaluation System dependencies..." >&2

    # Check if Python is available
    PYTHON_CMD=""
    if command -v py &> /dev/null; then
        PYTHON_CMD="py"
        echo "Using Python command: py" >&2
    elif command -v python3 &> /dev/null; then
        PYTHON_CMD="python3"
        echo "Using Python command: python3" >&2
    elif command -v python &> /dev/null; then
        PYTHON_CMD="python"
        echo "Using Python command: python" >&2
    else
        echo "Error: Python is not installed or not in PATH" >&2
        exit 1
    fi

    # Check if pip is available
    if ! $PYTHON_CMD -m pip --version &> /dev/null; then
        echo "Error: pip is not available. Please install pip first." >&2
        exit 1
    fi

    # Install requirements
    if [ -f "requirements.txt" ]; then
        echo "Installing packages from requirements.txt..." >&2
        
        if $PYTHON_CMD -m pip install -r requirements.txt --user > /dev/null 2>&1; then
            echo "âœ“ All dependencies installed successfully!" >&2
            exit 0
        else
            echo "Error: Failed to install dependencies" >&2
            exit 1
        fi
    else
        echo "Error: requirements.txt not found" >&2
        exit 1
    fi
}

# Function to run tests
run_tests() {
    # Check if Python is available
    PYTHON_CMD=""
    if command -v py &> /dev/null; then
        PYTHON_CMD="py"
    elif command -v python3 &> /dev/null; then
        PYTHON_CMD="python3"
    elif command -v python &> /dev/null; then
        PYTHON_CMD="python"
    else
        echo "Error: Python is not installed" >&2
        exit 1
    fi
    
    # Check if pytest is installed
    if ! $PYTHON_CMD -m pytest --version &> /dev/null; then
        echo "Error: pytest is not installed. Run './run install' first." >&2
        exit 1
    fi
    
    # Run pytest with coverage
    temp_output=$(mktemp)
    
    # Run tests and capture output
    $PYTHON_CMD -m pytest backend/src/Testing/ \
        --cov=backend/src \
        --cov-report=term \
        --tb=short \
        -v 2>&1 | tee "$temp_output" >&2
    
    test_exit_code=${PIPESTATUS[0]}
    
    # Parse test results more robustly
    passed_tests=0
    failed_tests=0
    total_tests=0
    coverage_percentage=0
    
    # Extract passed tests
    if grep -oE "[0-9]+ passed" "$temp_output" > /dev/null; then
        passed_tests=$(grep -oE "[0-9]+ passed" "$temp_output" | head -1 | grep -oE "[0-9]+")
    fi
    
    # Extract failed tests
    if grep -oE "[0-9]+ failed" "$temp_output" > /dev/null; then
        failed_tests=$(grep -oE "[0-9]+ failed" "$temp_output" | head -1 | grep -oE "[0-9]+")
    fi
    
    # Calculate total
    total_tests=$((passed_tests + failed_tests))
    
    # If no tests found, try to count from verbose output
    if [ $total_tests -eq 0 ]; then
        passed_tests=$(grep -c "PASSED" "$temp_output" || echo "0")
        failed_tests=$(grep -c "FAILED" "$temp_output" || echo "0")
        total_tests=$((passed_tests + failed_tests))
    fi
    
    # Extract coverage from TOTAL line (last percentage on the TOTAL line)
    if grep "TOTAL" "$temp_output" > /dev/null; then
        # Get the TOTAL line and extract the percentage
        coverage_line=$(grep "TOTAL" "$temp_output" | tail -1)
        coverage_percentage=$(echo "$coverage_line" | grep -oE "[0-9]+%" | tail -1 | grep -oE "[0-9]+")
    fi
    
    # Ensure we have valid numbers
    passed_tests=${passed_tests:-0}
    total_tests=${total_tests:-0}
    coverage_percentage=${coverage_percentage:-0}
    
    # Clean up temp file
    rm -f "$temp_output"
    
    # Output MUST be exactly this format (to stdout, not stderr)
    echo "${passed_tests}/${total_tests} test cases passed. ${coverage_percentage}% line coverage achieved."
    
    # Exit with appropriate code
    exit $test_exit_code
}

# Function to run evaluation on URL file
run_evaluation() {
    local url_file="$1"
    
    # Check if file exists
    if [ ! -f "$url_file" ]; then
        echo "Error: URL file not found: $url_file" >&2
        exit 1
    fi
    
    # Check if Python is available
    PYTHON_CMD="python3"
    if ! command -v python3 &> /dev/null; then
        PYTHON_CMD="python"
    fi
    
    if ! command -v $PYTHON_CMD &> /dev/null; then
        echo "Error: Python is not installed" >&2
        exit 1
    fi
    
    # Run evaluation from backend directory
    cd backend
    $PYTHON_CMD src/main.py "$url_file"
    exit_code=$?
    
    exit $exit_code
}

# Function to show usage
show_usage() {
    echo "Usage: ./run [install|test|URL_FILE]" >&2
    echo "" >&2
    echo "Commands:" >&2
    echo "  install     Install all required dependencies" >&2
    echo "  test        Run the test suite" >&2
    echo "  URL_FILE    Run evaluation on URLs in the specified file" >&2
}

# Main script logic
main() {
    if [ $# -eq 0 ]; then
        echo "Error: No command specified" >&2
        show_usage
        exit 1
    fi
    
    local command="$1"
    
    case "$command" in
        "install")
            install_dependencies
            ;;
        "test")
            run_tests
            ;;
        "-h"|"--help"|"help")
            show_usage
            exit 0
            ;;
        *)
            # Assume it's a URL file
            run_evaluation "$command"
            ;;
    esac
}

# Run main function
main "$@"